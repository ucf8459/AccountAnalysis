<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Analysis</title>
    <!-- Bootstrap CDN for quick styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .table-container { max-width: 1400px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 32px; }
        h2 { margin-bottom: 24px; }
        th { background: #f1f3f5; font-weight: 600; cursor: pointer; user-select: none; color: black; }
        th:hover { background: #e9ecef; }
        th.sortable { position: relative; padding-right: 25px !important; }
        th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 14px; }
        th.sort-asc::after { content: '↑'; opacity: 1; }
        th.sort-desc::after { content: '↓'; opacity: 1; }
        #loading { text-align: center; margin: 32px 0; }
        .period-selector { margin-bottom: 24px; }
        .table-responsive { overflow-x: auto; overflow-y: auto; max-height: 600px; }
        thead { position: sticky; top: 0; z-index: 10; }
        thead th { background: #f1f3f5; }
        .totals-row { position: sticky; bottom: 0; z-index: 10; background-color: #0d6efd !important; color: white !important; }
        .totals-row td { border-color: #0b5ed7 !important; }
        .currency { text-align: right; }
        .number { text-align: right; }
        .collector-y { color: #198754; font-weight: bold; }
        .collector-n { color: #dc3545; font-weight: bold; }
        .delta-positive { color: #198754; }
        .delta-negative { color: #dc3545; }
        .table-dark { background-color: #343a40; color: white; }
        .table-dark td { border-color: #495057; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        .collection-cell {
            text-align: center;
        }
        .period-badge-1 { background-color: #e3f2fd !important; color: #1976d2; }
        .period-badge-2 { background-color: #bbdefb !important; color: #1976d2; }
        .period-badge-3 { background-color: #90caf9 !important; color: #1565c0; }
        .period-badge-4 { background-color: #64b5f6 !important; color: #0d47a1; }
        .period-badge-5 { background-color: #2196f3 !important; color: #fff; }
        .period-badge-6 { background-color: #1565c0 !important; color: #fff; }
        .practice-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }
        .practice-link:hover {
            color: #1565c0;
            text-decoration: underline;
        }
        .badge-ta {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.85em;
            font-weight: 700;
            line-height: 1;
            border-radius: 0.375rem;
            vertical-align: baseline;
            background-color: #ffc107;
            border: 1.5px solid #222;
            color: #222;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white rounded dashboard-nav mb-4">
        <a class="navbar-brand fw-bold" href="/dashboard">Financial Dashboard</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/dashboard" onclick="showSection && showSection('company'); return false;">Company</a></li>
                <li class="nav-item"><a class="nav-link" href="/dashboard" onclick="showSection && showSection('territories'); return false;">Territories</a></li>
                <li class="nav-item"><a class="nav-link active" href="/account-table">Account Table</a></li>
            </ul>
            <div class="navbar-nav">
                <div class="nav-item d-flex align-items-center">
                    <label for="periodSelector" class="form-label me-2 mb-0">Time Period:</label>
                    <select id="periodSelector" class="form-select d-inline-block w-auto">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>
    </nav>
    <div id="loginModal" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2000;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Login</h5>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="loginUsername" class="form-label">Username</label>
                <input type="text" class="form-control" id="loginUsername" required />
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" required />
              </div>
              <div id="loginError" class="text-danger mb-2" style="display:none;"></div>
              <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Account Analysis</h2>
            <div class="d-flex gap-3">
                <div class="territory-selector">
                    <label for="territorySelector" class="form-label me-2">Territory:</label>
                    <select id="territorySelector" class="form-select d-inline-block w-auto">
                        <option value="all" selected>All Territories</option>
                        <option value="Alpha">Alpha</option>
                        <option value="Bravo">Bravo</option>
                        <option value="Charlie">Charlie</option>
                        <option value="Delta">Delta</option>
                        <option value="Echo">Echo</option>
                        <option value="Foxtrot">Foxtrot</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Filter Buttons and Metrics -->
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2">
                            <button id="btn-hi-lo" type="button" class="btn btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Show top 5 and bottom 5 practices by Net Income for the selected period and territory.">Hi/Lo</button>
            <button id="btn-collectors" type="button" class="btn btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Show all accounts with a collector.">Collectors</button>
                <button id="btn-reset" type="button" class="btn btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Reset to the most recent month, all territories, and clear filters.">Reset</button>
            </div>
            <div class="d-flex gap-4 align-items-center">
                <div class="text-center">
                    <div class="fw-bold text-info">ROS</div>
                    <div id="ros-metric" class="fs-5 fw-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="fw-bold text-primary">New Accounts</div>
                    <div id="new-accounts-count" class="fs-5 fw-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="fw-bold text-secondary">Total Accounts</div>
                    <div id="total-accounts-count" class="fs-5 fw-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="fw-bold">Net Income</div>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="text-success fw-bold" id="positive-accounts">-</span>
                        <span class="text-muted">/</span>
                        <span class="text-danger fw-bold" id="negative-accounts">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <table id="accountTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                    <th class="sortable" data-sort="practice">Practice</th>
                    <th class="sortable" data-sort="territory">Territory</th>
                    <th class="sortable currency" data-sort="revenue">Revenue</th>
                    <th class="sortable currency" data-sort="net_income">Net Income</th>
                    <th class="sortable" data-sort="collection_pct">Collection %</th>
                    <th class="sortable" data-sort="sample_count">Samples</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        
        <div id="error" class="alert alert-danger" style="display:none;"></div>
        <div class="mt-3 text-muted small">
            <p><strong>Badges:</strong> Blue badge = number of periods used in historical average (1–6). <span class="badge badge-ta">-</span> = territory average used due to lack of practice history.</p>
        </div>
    </div>
    
    <div class="modal fade" id="finClassModal" tabindex="-1" aria-labelledby="finClassModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finClassModalLabel">Financial Class Breakdown</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="finClassPeriod" class="mb-2 text-primary fw-semibold"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                        <h5 class="mb-0">Payer Mix</h5>
                        <div id="finClassTotalMC" class="fw-semibold"></div>
                    </div>
                    <div id="finClassPayerMix" class="mt-1"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="practiceDetailsModal" tabindex="-1" aria-labelledby="practiceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content position-relative">
                <div class="modal-header">
                    <h5 class="modal-title" id="practiceDetailsModalLabel">Practice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Revenue Breakdown</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Placed:</strong></td><td class="text-end" id="modal-placed">-</td></tr>
                                <tr><td><strong>Revenue:</strong></td><td class="text-end" id="modal-revenue">-</td></tr>
                                <tr><td><strong>COGS:</strong></td><td class="text-end" id="modal-cogs">-</td></tr>
                                <tr><td><strong>Gross Profit:</strong></td><td class="text-end" id="modal-profit">-</td></tr>
                                <tr><td><strong>Sales Expense:</strong></td><td class="text-end" id="modal-sales-expense">-</td></tr>
                                <tr><td><strong>Net Income:</strong></td><td class="text-end" id="modal-net-income">-</td></tr>
                                <tr><td><strong>ROS:</strong></td><td class="text-end" id="modal-ros">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Per-Sample Metrics</h6>
                            <table class="table table-sm">
                                <tr><td><strong>BPS:</strong></td><td class="text-end" id="modal-bps">-</td></tr>
                                <tr><td><strong>RPS:</strong></td><td class="text-end" id="modal-rps">-</td></tr>
                                <tr><td><strong>GPPS:</strong></td><td class="text-end" id="modal-gpps">-</td></tr>
                                <tr><td><strong>SEPS:</strong></td><td class="text-end" id="modal-eps">-</td></tr>
                                <tr><td><strong>NIPS:</strong></td><td class="text-end" id="modal-nips">-</td></tr>
                            </table>
                            <div class="mt-3">
                                <span id="modal-mc-label"><strong>M/C %:</strong></span>
                                <span id="modal-mc" style="font-weight:bold; cursor:pointer;">-</span>
                            </div>
                            <div class="mt-2">
                                <span id="modal-collector-indicator" class="badge"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Territory badge at bottom right -->
                <span id="modal-territory-badge" class="badge position-absolute" style="bottom: 18px; right: 24px; font-size: 1.1em;"></span>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = [];
        let currentTotals = null;
        let currentSort = { column: null, direction: 'asc' };
        let currentFilter = null;
        
        // Sorting function
        function sortData(data, column, direction) {
            return data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle numeric values
                if (["placed", "revenue", "profit", "rps", "gpps", "eps", "nips"].includes(column)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                // Handle string values
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        // Update sort indicators
        function updateSortIndicators(column, direction) {
            const headers = document.querySelectorAll('th.sortable');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === column) {
                    header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // Render table with current data and sort
        function renderTable() {
            console.log('Rendering table with data:', currentData.length, 'rows');
            const tbody = document.querySelector('#accountTable tbody');
            tbody.innerHTML = '';
            
            let displayData = [...currentData];
            
            // Apply territory filter if not all
            const territorySelector = document.getElementById('territorySelector');
            const selectedTerritory = territorySelector ? territorySelector.value : 'all';
            if (selectedTerritory !== 'all') {
                displayData = displayData.filter(account => account.territory === selectedTerritory);
            }
            
            // Apply filter buttons
            if (currentFilter === 'hi-lo') {
                // Top 5 and bottom 5 by Net Income, no overlap, top sorted descending, bottom sorted ascending
                const sortedDesc = [...displayData].sort((a, b) => (b.net_income || 0) - (a.net_income || 0));
                const top5 = sortedDesc.slice(0, 5);
                const sortedAsc = [...displayData].sort((a, b) => (a.net_income || 0) - (b.net_income || 0));
                const bottom5 = sortedAsc.slice(0, 5);
                // Remove overlap (if any practice is in both, only show in top)
                const bottom5Filtered = bottom5.filter(row => !top5.some(top => top.practice === row.practice && top.territory === row.territory));
                displayData = [...top5, ...bottom5Filtered];
            } else if (currentFilter === 'collectors') {
                // Accounts with a collector
                displayData = displayData.filter(row => row.collector === 'Y');
            }
            
            // Apply sorting if column is selected
            if (currentSort.column) {
                displayData = sortData(displayData, currentSort.column, currentSort.direction);
            }
            
            // Determine if we are showing all territories
            let totalsToShow;
            if (displayData.length === 0) {
                totalsToShow = null;
            } else {
                // Calculate totals for visible data (all or filtered)
                let totalPlaced = 0, totalRevenue = 0, totalCogs = 0, totalProfit = 0, totalSalesExpense = 0, totalNetIncome = 0, totalCollectorCost = 0, totalSamples = 0;
                let sumRps = 0, sumBps = 0, sumGpps = 0, sumEps = 0, sumNips = 0, count = 0;
                displayData.forEach(row => {
                    totalPlaced += row.placed || 0;
                    totalRevenue += row.revenue || 0;
                    totalCogs += row.cogs || 0;
                    totalProfit += row.profit || 0;
                    totalSalesExpense += row.sales_expense || 0;
                    totalNetIncome += row.net_income || 0;
                    totalCollectorCost += row.collector_cost || 0;
                    totalSamples += row.sample_count || 0;
                    sumRps += row.rps || 0;
                    sumBps += row.bps || 0;
                    sumGpps += row.gpps || 0;
                    sumEps += row.eps || 0;
                    sumNips += row.nips || 0;
                    count++;
                });
                
                const avgCogs = count ? totalCogs / count : 0;
                const avgRps = totalSamples ? totalRevenue / totalSamples : 0;
                const avgBps = count ? sumBps / count : 0;
                const avgGpps = totalSamples ? totalProfit / totalSamples : 0;
                const avgEps = totalSamples ? totalSalesExpense / totalSamples : 0;
                const avgCollectorCost = count ? totalCollectorCost / count : 0;
                const avgNips = totalSamples ? totalNetIncome / totalSamples : 0;
                // Collection % as revenue / placed
                const collectionPct = totalPlaced > 0 ? (totalRevenue / totalPlaced * 100) : 0;
                // COGS should be a sum, not an average
                const totalCogsValue = totalCogs;
                totalsToShow = {
                    practice: 'TOTAL',
                    territory: '',
                    placed: totalPlaced,
                    revenue: totalRevenue,
                    cogs: totalCogsValue,
                    profit: totalProfit,
                    sales_expense: totalSalesExpense,
                    net_income: totalNetIncome,
                    collection_pct: `${collectionPct.toFixed(1)}%`,
                    revenue_periods: 0,
                    rps: avgRps,
                    bps: avgBps,
                    gpps: avgGpps,
                    eps: avgEps,
                    nips: avgNips,
                    collector: '',
                    collector_cost: avgCollectorCost,
                    sample_count: totalSamples
                };
            }
            
            // Render data rows
            let rowCount = 0;
            let hiLoSeparatorDrawn = false;
            console.log('Rendering', displayData.length, 'rows');
            displayData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const deltaClass = row.nips >= 0 ? 'delta-positive' : 'delta-negative';
                const collectorClass = row.collector === 'Y' ? 'collector-y' : 'collector-n';
                // Territory color mapping
                const territoryColors = {
                    'Alpha': '#0d6efd',
                    'Bravo': '#6c757d',
                    'Charlie': '#ffc107',
                    'Delta': '#198754',
                    'Echo': '#fd7e14',
                    'Foxtrot': '#6610f2'
                };
                const territoryColor = territoryColors[row.territory] || '#adb5bd';
                tr.innerHTML = `
                    <td><a href="#" class="practice-link" data-practice="${encodeURIComponent(row.practice)}" data-row='${JSON.stringify(row)}'>${row.practice}</a></td>
                    <td><span class="badge" style="background-color:${territoryColor};color:${['#ffc107','#fd7e14'].includes(territoryColor)?'black':'white'}">${row.territory}</span></td>
                    <td class="currency">${row.revenue !== undefined ? `$${Math.round(row.revenue).toLocaleString()}` : ''}</td>
                    <td class="currency">
                        ${row.net_income !== undefined ? `$${Math.round(row.net_income).toLocaleString()}` : ''}
                    </td>
                    <td class="collection-cell">
                        <span>${row.collection_pct}</span>&nbsp;&nbsp;&nbsp;
                        ${row.revenue_periods > 0
                            ? `<span class='badge period-badge-${Math.min(row.revenue_periods,6)}'>${row.revenue_periods}</span>`
                            : `<span class='badge badge-ta ms-1'>-</span>`}
                    </td>
                    <td>${row.sample_count}</td>
                `;
                tbody.appendChild(tr);
                rowCount++;
                // Draw separator after top5 for Hi/Lo
                if (currentFilter === 'hi-lo' && !hiLoSeparatorDrawn && rowCount === 5) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.className = 'separator-row';
                    separatorRow.style.backgroundColor = '#f8f9fa';
                    separatorRow.style.borderTop = '2px solid #dee2e6';
                    separatorRow.style.borderBottom = '2px solid #dee2e6';
                    separatorRow.innerHTML = `
                        <td colspan="6" style="text-align: center; padding: 8px; font-weight: bold; color: #6c757d; font-size: 0.9em;">
                            ─── Bottom 5 Practices ───
                        </td>
                    `;
                    tbody.appendChild(separatorRow);
                    hiLoSeparatorDrawn = true;
                }
            });
            
            // Render totals row
            if (displayData.length > 0 && totalsToShow) {
                const totalsRow = document.createElement('tr');
                totalsRow.className = 'totals-row fw-bold';
                totalsRow.style.backgroundColor = '#0d6efd';
                totalsRow.style.color = 'white';
                totalsRow.style.position = 'sticky';
                totalsRow.style.bottom = '0';
                totalsRow.style.zIndex = '10';
                totalsRow.innerHTML = `
                    <td style="border-color: #0b5ed7;"><strong>${totalsToShow.practice}</strong></td>
                    <td style="border-color: #0b5ed7;"></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${Math.round(totalsToShow.revenue).toLocaleString()}</strong></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${Math.round(totalsToShow.net_income).toLocaleString()}</strong></td>
                    <td class="collection-cell" style="border-color: #0b5ed7;"><strong>${totalsToShow.collection_pct}</strong></td>
                    <td style="border-color: #0b5ed7;"><strong>${totalsToShow.sample_count.toLocaleString()}</strong></td>
                `;
                tbody.appendChild(totalsRow);
            }
        }
        
        async function loadAccountTable(periodType = 'ytd', territory = 'all') {
            const loading = document.getElementById('loading');
            const table = document.getElementById('accountTable');
            const errorDiv = document.getElementById('error');
            
            try {
                loading.style.display = '';
                table.style.display = 'none';
                errorDiv.style.display = 'none';
                
                console.log('Loading account table for period:', periodType, 'territory:', territory);
                
                const response = await fetch(`/api/dashboard/account-table-live?period_type=${periodType}`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                console.log('Received data:', data);
                console.log('Number of accounts:', data.accounts ? data.accounts.length : 0);
                
                // Filter accounts by territory if not "all"
                let filteredAccounts = data.accounts;
                if (territory !== 'all') {
                    filteredAccounts = data.accounts.filter(account => account.territory === territory);
                }
                
                console.log('Filtered accounts:', filteredAccounts.length);
                
                // Store current data and totals
                currentData = filteredAccounts;
                currentTotals = data.totals;
                renderTable();
                
                // Load account metrics
                await loadAccountMetrics(periodType, territory);
                
                loading.style.display = 'none';
                table.style.display = '';
            } catch (err) {
                console.error('Error loading account table:', err);
                loading.style.display = 'none';
                errorDiv.textContent = err.message;
                errorDiv.style.display = '';
            }
        }
        
        async function loadAccountMetrics(periodType, territory = 'all') {
            try {
                const response = await fetch(`/api/dashboard/account-metrics?period_type=${periodType}&territory=${territory}`);
                if (!response.ok) throw new Error('Failed to fetch metrics');
                
                const data = await response.json();
                
                // Update the metrics display
                document.getElementById('new-accounts-count').textContent = data.new_accounts || 0;
                document.getElementById('total-accounts-count').textContent = data.total_accounts || 0;
                document.getElementById('positive-accounts').textContent = data.positive_accounts || 0;
                document.getElementById('negative-accounts').textContent = data.negative_accounts || 0;
                
                // Calculate and display ROS metric
                const rosMetric = document.getElementById('ros-metric');
                if (data.total_net_income !== undefined && data.total_sales_expense !== undefined) {
                    const ros = data.total_sales_expense > 0 ? (data.total_net_income / data.total_sales_expense * 100) : 0;
                    rosMetric.textContent = `${Math.round(ros)}%`;
                    rosMetric.style.color = ros < 0 ? 'red' : '';
                } else {
                    rosMetric.textContent = '-';
                }
            } catch (err) {
                console.error('Failed to load account metrics:', err);
                // Set default values on error
                document.getElementById('new-accounts-count').textContent = '-';
                document.getElementById('total-accounts-count').textContent = '-';
                document.getElementById('positive-accounts').textContent = '-';
                document.getElementById('negative-accounts').textContent = '-';
                document.getElementById('ros-metric').textContent = '-';
            }
        }
        
        // Function to reload data with current filter values
        function reloadData() {
            const periodType = document.getElementById('periodSelector').value;
            const territory = document.getElementById('territorySelector') ? document.getElementById('territorySelector').value : 'all';
            loadAccountTable(periodType, territory);
        }
        
        // Sort handler
        function handleSort(column) {
            if (currentSort.column === column) {
                // Toggle direction if same column
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            updateSortIndicators(currentSort.column, currentSort.direction);
            renderTable();
        }
        
        // Period selector change handler
        document.getElementById('periodSelector').addEventListener('change', reloadData);
        document.getElementById('territorySelector').addEventListener('change', reloadData);
        
        // Add click handlers for sorting
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('sortable')) {
                const column = e.target.getAttribute('data-sort');
                if (column) {
                    handleSort(column);
                }
            }
        });
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Populate period selector
            populatePeriodSelector();
            
            // Load initial data with the most recent month
            const periodSelector = document.getElementById('periodSelector');
            const initialPeriod = periodSelector.value;
            console.log('Initial period:', initialPeriod);
            loadAccountTable(initialPeriod, 'all');

            // Add event listeners for collector cost inputs
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('collector-cost-input')) {
                    const practice = decodeURIComponent(e.target.getAttribute('data-practice'));
                    const collectorCost = parseFloat(e.target.value) || 0;
                    updateCollectorCost(practice, collectorCost);
                }
            });

            // Filter button event listeners
            document.getElementById('btn-hi-lo').addEventListener('click', function() { 
                applyFilter('hi-lo'); 
                updateFilterButtonStates();
            });
            document.getElementById('btn-collectors').addEventListener('click', function() {
                applyFilter('collectors');
                updateFilterButtonStates();
            });
            document.getElementById('btn-reset').addEventListener('click', function() {
                // Reset period to most recent
                const periodSelector = document.getElementById('periodSelector');
                if (periodSelector.options.length > 0) {
                    periodSelector.selectedIndex = 0;
                }
                // Reset territory to all
                const territorySelector = document.getElementById('territorySelector');
                if (territorySelector) {
                    territorySelector.value = 'all';
                }
                // Clear filter
                currentFilter = null;
                reloadData();
                updateFilterButtonStates();
            });

            // Practice name click handler for modal
            document.getElementById('accountTable').addEventListener('click', async function(e) {
                if (e.target && e.target.classList.contains('practice-link')) {
                    e.preventDefault();
                    const practice = decodeURIComponent(e.target.getAttribute('data-practice'));
                    const rowData = JSON.parse(e.target.getAttribute('data-row'));
                    // Populate modal with data (reuse details modal logic)
                    document.getElementById('practiceDetailsModalLabel').textContent = practice;
                    // Helper function to format currency with red color for negative values
                    function formatCurrency(value, decimals = 0) {
                        const numValue = parseFloat(value || 0);
                        const formatted = decimals === 0 ? 
                            `$${Math.round(numValue).toLocaleString()}` : 
                            `$${numValue.toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}`;
                        return { text: formatted, isNegative: numValue < 0 };
                    }

                    // Update modal fields with conditional red coloring
                    const placedEl = document.getElementById('modal-placed');
                    const placedData = formatCurrency(rowData.placed);
                    placedEl.textContent = placedData.text;
                    placedEl.style.color = placedData.isNegative ? 'red' : '';

                    const revenueEl = document.getElementById('modal-revenue');
                    const revenueData = formatCurrency(rowData.revenue);
                    revenueEl.textContent = revenueData.text;
                    revenueEl.style.color = revenueData.isNegative ? 'red' : '';

                    const cogsEl = document.getElementById('modal-cogs');
                    const cogsData = formatCurrency(rowData.cogs);
                    cogsEl.textContent = cogsData.text;
                    cogsEl.style.color = cogsData.isNegative ? 'red' : '';

                    const profitEl = document.getElementById('modal-profit');
                    const profitData = formatCurrency(rowData.profit);
                    profitEl.textContent = profitData.text;
                    profitEl.style.color = profitData.isNegative ? 'red' : '';

                    const salesExpenseEl = document.getElementById('modal-sales-expense');
                    const salesExpenseData = formatCurrency(rowData.sales_expense);
                    salesExpenseEl.textContent = salesExpenseData.text;
                    salesExpenseEl.style.color = salesExpenseData.isNegative ? 'red' : '';

                    const netIncomeEl = document.getElementById('modal-net-income');
                    const netIncomeData = formatCurrency(rowData.net_income);
                    netIncomeEl.textContent = netIncomeData.text;
                    netIncomeEl.style.color = netIncomeData.isNegative ? 'red' : '';

                    const bpsEl = document.getElementById('modal-bps');
                    const bpsData = formatCurrency(rowData.bps, 2);
                    bpsEl.textContent = bpsData.text;
                    bpsEl.style.color = bpsData.isNegative ? 'red' : '';

                    const rpsEl = document.getElementById('modal-rps');
                    const rpsData = formatCurrency(rowData.rps, 2);
                    rpsEl.textContent = rpsData.text;
                    rpsEl.style.color = rpsData.isNegative ? 'red' : '';

                    const gppsEl = document.getElementById('modal-gpps');
                    const gppsData = formatCurrency(rowData.gpps, 2);
                    gppsEl.textContent = gppsData.text;
                    gppsEl.style.color = gppsData.isNegative ? 'red' : '';

                    const epsEl = document.getElementById('modal-eps');
                    const epsData = formatCurrency(rowData.eps, 2);
                    epsEl.textContent = epsData.text;
                    epsEl.style.color = epsData.isNegative ? 'red' : '';

                    const nipsEl = document.getElementById('modal-nips');
                    const nipsData = formatCurrency(rowData.nips, 2);
                    nipsEl.textContent = nipsData.text;
                    nipsEl.style.color = nipsData.isNegative ? 'red' : '';

                    const rosEl = document.getElementById('modal-ros');
                    const rosValue = rowData.ros || 0;
                    rosEl.textContent = `${rosValue}%`;
                    rosEl.style.color = rosValue < 0 ? 'red' : '';
                    // Collector indicator
                    const collectorIndicator = document.getElementById('modal-collector-indicator');
                    if (rowData.collector === 'Y') {
                        collectorIndicator.textContent = 'Collector: Y';
                        collectorIndicator.className = 'badge bg-success';
                    } else {
                        collectorIndicator.textContent = 'Collector: N';
                        collectorIndicator.className = 'badge bg-secondary';
                    }
                    // Territory badge (bottom right)
                    const territoryColors = {
                        'Alpha': '#0d6efd',
                        'Bravo': '#6c757d',
                        'Charlie': '#ffc107',
                        'Delta': '#198754',
                        'Echo': '#fd7e14',
                        'Foxtrot': '#6610f2'
                    };
                    const territoryBadge = document.getElementById('modal-territory-badge');
                    const territoryColor = territoryColors[rowData.territory] || '#adb5bd';
                    territoryBadge.textContent = rowData.territory || '';
                    territoryBadge.style.backgroundColor = territoryColor;
                    territoryBadge.style.color = ['#ffc107','#fd7e14'].includes(territoryColor)?'black':'white';
                    // M/C %
                    fetch(`/api/dashboard/financial-class-breakdown?practice=${encodeURIComponent(practice)}&period_type=${document.getElementById('periodSelector').value}`)
                        .then(res => res.json())
                        .then(data => {
                            let totalMC = 0;
                            if (data.breakdown) {
                                data.breakdown.forEach(item => {
                                    if (item.class === 'CARE' || item.class === 'HCARE') {
                                        totalMC += parseFloat(item.percent);
                                    }
                                });
                            }
                            const mcSpan = document.getElementById('modal-mc');
                            mcSpan.textContent = `${totalMC.toFixed(1)}%`;
                            mcSpan.style.color = totalMC >= 30 ? 'green' : 'red';
                            mcSpan.onclick = function() {
                                // Show payer mix modal
                                let rows = '';
                                if (data.breakdown) {
                                    rows = data.breakdown.map(item => {
                                        const highlight = ['HCARE', 'CARE', 'HUM', 'UHC', 'AETNA'].includes(item.class) ? " style='background:#ffeeba;font-weight:bold;'" : '';
                                        return `<tr${highlight}><td>${item.class}</td><td>${item.percent}%</td></tr>`;
                                    }).join('');
                                }
                                const payerMixHtml = `<table class='table table-sm table-bordered'><thead><tr><th>Financial Class</th><th>% of Total</th></tr></thead><tbody>${rows}</tbody></table>`;
                                const payerMixModal = new bootstrap.Modal(document.getElementById('payerMixModal'));
                                document.getElementById('payerMixModalLabel').textContent = practice + ' - Payer Mix';
                                document.getElementById('payerMixModalBody').innerHTML = payerMixHtml;
                                payerMixModal.show();
                            };
                        });
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('practiceDetailsModal'));
                    modal.show();
                }
            });

            // Show login modal if not logged in
            if (!isLoggedIn()) {
              showLoginModal();
            }
            // Login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
              loginForm.addEventListener('submit', async function(e) {
                                  e.preventDefault();
                  // Authentication removed - no longer needed
              });
            }

            // On page load, ensure filter button states are correct
            updateFilterButtonStates();
        });

        // Function to populate period selector with months
        function populatePeriodSelector() {
            console.log('Populating period selector...');
            const periodSelector = document.getElementById('periodSelector');
            const months = [
                { value: 'june_2025', displayName: 'June 2025' },
                { value: 'may_2025', displayName: 'May 2025' },
                { value: 'april_2025', displayName: 'April 2025' },
                { value: 'march_2025', displayName: 'March 2025' },
                { value: 'february_2025', displayName: 'February 2025' },
                { value: 'january_2025', displayName: 'January 2025' },
                { value: 'ytd', displayName: 'Year-to-Date' }
            ];
            periodSelector.innerHTML = '';
            months.forEach((monthData, index) => {
                const option = document.createElement('option');
                option.value = monthData.value;
                option.textContent = monthData.displayName;
                if (index === 0) {
                    option.selected = true;
                }
                periodSelector.appendChild(option);
            });
            console.log('Period selector populated with', months.length, 'options');
            console.log('Selected period:', periodSelector.value);
        }

        // Function to update collector cost
        async function updateCollectorCost(practice, collectorCost) {
            const input = document.querySelector(`[data-practice="${encodeURIComponent(practice)}"].collector-cost-input`);
            const spinner = input.parentElement.querySelector('.collector-spinner');
            
            try {
                spinner.style.display = 'inline-block';
                input.disabled = true;
                
                const response = await fetch('/api/dashboard/update-collector-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        practice: practice,
                        collector_cost: collectorCost
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update collector cost');
                }
                
                // Reload data to reflect changes
                reloadData();
                
            } catch (error) {
                console.error('Error updating collector cost:', error);
                alert('Failed to update collector cost. Please try again.');
                // Reset input to previous value
                reloadData();
            } finally {
                spinner.style.display = 'none';
                input.disabled = false;
            }
        }

        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Filter button handlers
        function applyFilter(filterType) {
            currentFilter = filterType;
            renderTable();
        }

        // Add this function to update filter button states
        function updateFilterButtonStates() {
            document.getElementById('btn-hi-lo').classList.remove('active');
            document.getElementById('btn-collectors').classList.remove('active');
            // Highlight the active filter
            if (currentFilter === 'hi-lo') {
                document.getElementById('btn-hi-lo').classList.add('active');
            } else if (currentFilter === 'collectors') {
                document.getElementById('btn-collectors').classList.add('active');
            }
        }
    </script>

    <!-- Payer Mix Modal -->
    <div class="modal fade" id="payerMixModal" tabindex="-1" aria-labelledby="payerMixModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payerMixModalLabel">Payer Mix</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="payerMixModalBody">
                </div>
            </div>
        </div>
    </div>
</body>
</html>