<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Table</title>
    <!-- Bootstrap CDN for quick styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .table-container { max-width: 1400px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 32px; }
        h2 { margin-bottom: 24px; }
        th { background: #f1f3f5; font-weight: 600; cursor: pointer; user-select: none; color: black; }
        th:hover { background: #e9ecef; }
        th.sortable { position: relative; padding-right: 25px !important; }
        th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 14px; }
        th.sort-asc::after { content: '↑'; opacity: 1; }
        th.sort-desc::after { content: '↓'; opacity: 1; }
        #loading { text-align: center; margin: 32px 0; }
        .period-selector { margin-bottom: 24px; }
        .table-responsive { overflow-x: auto; overflow-y: auto; max-height: 600px; }
        thead { position: sticky; top: 0; z-index: 10; }
        thead th { background: #f1f3f5; }
        .totals-row { position: sticky; bottom: 0; z-index: 10; background-color: #0d6efd !important; color: white !important; }
        .totals-row td { border-color: #0b5ed7 !important; }
        .currency { text-align: right; }
        .number { text-align: right; }
        .collector-y { color: #198754; font-weight: bold; }
        .collector-n { color: #dc3545; font-weight: bold; }
        .delta-positive { color: #198754; }
        .delta-negative { color: #dc3545; }
        .table-dark { background-color: #343a40; color: white; }
        .table-dark td { border-color: #495057; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        .collection-cell {
            text-align: center;
        }
        .period-badge-1 { background-color: #e3f2fd !important; color: #1976d2; }
        .period-badge-2 { background-color: #bbdefb !important; color: #1976d2; }
        .period-badge-3 { background-color: #90caf9 !important; color: #1565c0; }
        .period-badge-4 { background-color: #64b5f6 !important; color: #0d47a1; }
        .period-badge-5 { background-color: #2196f3 !important; color: #fff; }
        .period-badge-6 { background-color: #1565c0 !important; color: #fff; }
        .practice-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }
        .practice-link:hover {
            color: #1565c0;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="loginModal" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2000;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Login</h5>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="loginUsername" class="form-label">Username</label>
                <input type="text" class="form-control" id="loginUsername" required />
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" required />
              </div>
              <div id="loginError" class="text-danger mb-2" style="display:none;"></div>
              <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Account Table</h2>
            <div class="d-flex gap-3">
                <div class="period-selector">
                    <label for="periodSelector" class="form-label me-2">Time Period:</label>
                    <select id="periodSelector" class="form-select d-inline-block w-auto">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                    <div class="territory-selector">
                        <label for="territorySelector" class="form-label me-2">Territory:</label>
                        <select id="territorySelector" class="form-select d-inline-block w-auto">
                            <option value="all" selected>All Territories</option>
                            <option value="Alpha">Alpha</option>
                            <option value="Bravo">Bravo</option>
                            <option value="Charlie">Charlie</option>
                            <option value="Delta">Delta</option>
                            <option value="Echo">Echo</option>
                            <option value="Foxtrot">Foxtrot</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <table id="accountTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                    <th class="sortable" data-sort="practice">Practice</th>
                    <th class="sortable" data-sort="territory">Territory</th>
                    <th class="sortable currency" data-sort="revenue">Revenue</th>
                    <th class="sortable currency" data-sort="cogs">COGS</th>
                    <th class="sortable currency" data-sort="profit">Profit</th>
                    <th class="sortable" data-sort="collection_pct">Collection %</th>
                    <th class="sortable number" data-sort="rps">RPS</th>
                    <th class="sortable number" data-sort="bps">BPS</th>
                    <th class="sortable number" data-sort="pps">PPS</th>
                    <th class="sortable number" data-sort="cps">CPS</th>
                    <th class="sortable number" data-sort="delta">Delta</th>
                    <th class="sortable currency" data-sort="collector_cost">Collector Cost</th>
                    <th class="sortable" data-sort="sample_count">Samples</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        
        <div id="error" class="alert alert-danger" style="display:none;"></div>
        <div class="mt-3 text-muted small">
            <p><strong>*</strong> Collection % is weighted by revenue</p>
        </div>
    </div>
    
    <div class="modal fade" id="finClassModal" tabindex="-1" aria-labelledby="finClassModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finClassModalLabel">Financial Class Breakdown</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="finClassPeriod" class="mb-2 text-primary fw-semibold"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                        <h5 class="mb-0">Payer Mix</h5>
                        <div id="finClassTotalMC" class="fw-semibold"></div>
                    </div>
                    <div id="finClassPayerMix" class="mt-1"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = [];
        let currentTotals = null;
        let currentSort = { column: null, direction: 'asc' };
        
        // Sorting function
        function sortData(data, column, direction) {
            return data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle numeric values
                if (["revenue", "profit", "rps", "pps", "cps", "delta"].includes(column)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                // Handle string values
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }
        
        // Update sort indicators
        function updateSortIndicators(column, direction) {
            const headers = document.querySelectorAll('th.sortable');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === column) {
                    header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // Render table with current data and sort
        function renderTable() {
            const tbody = document.querySelector('#accountTable tbody');
            tbody.innerHTML = '';
            
            let displayData = [...currentData];
            
            // Apply sorting if column is selected
            if (currentSort.column) {
                displayData = sortData(displayData, currentSort.column, currentSort.direction);
            }
            
            // --- Calculate filtered totals ---
            let totalRevenue = 0, totalCogs = 0, totalProfit = 0, totalCollectorCost = 0, totalSamples = 0;
            let totalCollectionWeighted = 0, totalCollectionWeight = 0;
            let sumRps = 0, sumBps = 0, sumPps = 0, sumCps = 0, sumDelta = 0, count = 0;
            displayData.forEach(row => {
                totalRevenue += row.revenue || 0;
                totalCogs += row.cogs || 0;
                totalProfit += row.profit || 0;
                totalCollectorCost += row.collector_cost || 0;
                totalSamples += row.sample_count || 0;
                // Weighted collection %
                let pct = 0;
                if (typeof row.collection_pct === 'string' && row.collection_pct.endsWith('%')) {
                    pct = parseFloat(row.collection_pct) / 100;
                }
                if (pct > 0) {
                    totalCollectionWeighted += (row.revenue || 0) * pct;
                    totalCollectionWeight += (row.revenue || 0);
                }
                sumRps += row.rps || 0;
                sumBps += row.bps || 0;
                sumPps += row.pps || 0;
                sumCps += row.cps || 0;
                sumDelta += row.delta || 0;
                count++;
            });
            const avgCogs = count ? totalCogs / count : 0;
            const avgRps = totalSamples ? totalRevenue / totalSamples : 0;
            const avgBps = count ? sumBps / count : 0;
            const avgPps = totalSamples ? totalProfit / totalSamples : 0;
            const avgCps = totalSamples ? totalCogs / totalSamples : 0;
            const avgCollectorCost = count ? totalCollectorCost / count : 0;
            const avgDelta = avgRps - avgCps;
            const avgCollectionPct = totalCollectionWeight > 0 ? (totalCollectionWeighted / totalCollectionWeight * 100) : 0;
            const filteredTotals = {
                practice: 'TOTAL',
                territory: '',
                revenue: totalRevenue,
                cogs: avgCogs,
                profit: totalProfit,
                collection_pct: `${avgCollectionPct.toFixed(1)}%`,
                revenue_periods: 0,
                rps: avgRps,
                bps: avgBps,
                pps: avgPps,
                cps: avgCps,
                delta: avgDelta,
                collector: '',
                collector_cost: avgCollectorCost,
                sample_count: totalSamples
            };
            // --- End filtered totals ---
            
            // Render data rows
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                const deltaClass = row.delta >= 0 ? 'delta-positive' : 'delta-negative';
                const collectorClass = row.collector === 'Y' ? 'collector-y' : 'collector-n';
                
                tr.innerHTML = `
                    <td><a href="#" class="practice-link" data-practice="${encodeURIComponent(row.practice)}">${row.practice}</a></td>
                    <td><span class="badge bg-secondary">${row.territory}</span></td>
                    <td class="currency">${row.revenue !== undefined ? `$${Math.round(row.revenue).toLocaleString()}` : ''}</td>
                    <td class="currency">${row.cogs !== undefined ? `$${Math.round(row.cogs).toLocaleString()}` : ''}</td>
                    <td class="currency profit-cell">${row.profit !== undefined ? `$${Math.round(row.profit).toLocaleString()}` : ''}</td>
                    <td class="collection-cell">
                        <span>${row.collection_pct}</span>&nbsp;&nbsp;&nbsp;
                        ${row.collection_pct === '< 90' ? '<span class="badge bg-warning text-dark">0</span>' : (row.revenue_periods > 0 ? `<span class='badge period-badge-${Math.min(row.revenue_periods,6)}'>${row.revenue_periods}</span>` : '')}
                    </td>
                    <td class="number">${row.rps !== undefined ? `$${row.rps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}</td>
                    <td class="number">${row.bps !== undefined ? `$${row.bps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}</td>
                    <td class="number">${row.pps !== undefined ? `$${row.pps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}</td>
                    <td class="number">${row.cps !== undefined ? `$${row.cps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}</td>
                    <td class="number ${deltaClass}">${row.delta !== undefined ? `$${row.delta.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}</td>
                    <td class="currency">
                        <input type="number" class="form-control form-control-sm collector-cost-input" 
                               data-practice="${encodeURIComponent(row.practice)}" 
                               value="${row.collector_cost || 0}" 
                               step="0.01" 
                               min="0" 
                               style="width: 80px; text-align: right;"
                               placeholder="0.00" />
                        <span class="collector-spinner" style="display:none;"><span class="spinner-border spinner-border-sm text-primary"></span></span>
                    </td>
                    <td>${row.sample_count}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Render totals row for filtered data
            if (displayData.length > 0) {
                const totalsRow = document.createElement('tr');
                totalsRow.className = 'totals-row fw-bold';
                totalsRow.style.backgroundColor = '#0d6efd';
                totalsRow.style.color = 'white';
                totalsRow.style.position = 'sticky';
                totalsRow.style.bottom = '0';
                totalsRow.style.zIndex = '10';
                totalsRow.innerHTML = `
                    <td style="border-color: #0b5ed7;"><strong>${filteredTotals.practice}</strong></td>
                    <td style="border-color: #0b5ed7;"></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${Math.round(filteredTotals.revenue).toLocaleString()}</strong></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${Math.round(currentTotals.cogs).toLocaleString()}</strong></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${Math.round(filteredTotals.profit).toLocaleString()}</strong></td>
                    <td class="collection-cell" style="border-color: #0b5ed7;"><strong>${filteredTotals.collection_pct}*</strong></td>
                    <td class="number" style="border-color: #0b5ed7;"><strong>$${filteredTotals.rps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="number" style="border-color: #0b5ed7;"><strong>$${filteredTotals.bps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="number" style="border-color: #0b5ed7;"><strong>$${filteredTotals.pps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="number" style="border-color: #0b5ed7;"><strong>$${filteredTotals.cps.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="number" style="border-color: #0b5ed7;"><strong>$${filteredTotals.delta.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td class="currency" style="border-color: #0b5ed7;"><strong>$${filteredTotals.collector_cost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    <td style="border-color: #0b5ed7;"><strong>${filteredTotals.sample_count.toLocaleString()}</strong></td>
                `;
                tbody.appendChild(totalsRow);
            }
        }
        
        async function loadAccountTable(periodType = 'ytd', territory = 'all') {
            const loading = document.getElementById('loading');
            const table = document.getElementById('accountTable');
            const errorDiv = document.getElementById('error');
            
            try {
                loading.style.display = '';
                table.style.display = 'none';
                errorDiv.style.display = 'none';
                
                const response = await fetch(`/api/dashboard/account-table-live?period_type=${periodType}`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                
                // Filter accounts by territory if not "all"
                let filteredAccounts = data.accounts;
                if (territory !== 'all') {
                    filteredAccounts = data.accounts.filter(account => account.territory === territory);
                }
                
                // Store current data and totals
                currentData = filteredAccounts;
                currentTotals = data.totals;
                renderTable();
                
                loading.style.display = 'none';
                table.style.display = '';
            } catch (err) {
                loading.style.display = 'none';
                errorDiv.textContent = err.message;
                errorDiv.style.display = '';
            }
        }
        
        // Function to reload data with current filter values
        function reloadData() {
            const periodType = document.getElementById('periodSelector').value;
            const territory = document.getElementById('territorySelector') ? document.getElementById('territorySelector').value : 'all';
            loadAccountTable(periodType, territory);
        }
        
        // Sort handler
        function handleSort(column) {
            if (currentSort.column === column) {
                // Toggle direction if same column
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            updateSortIndicators(currentSort.column, currentSort.direction);
            renderTable();
        }
        
        // Period selector change handler
        document.getElementById('periodSelector').addEventListener('change', reloadData);
        document.getElementById('territorySelector').addEventListener('change', reloadData);
        
        // Add click handlers for sorting
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('sortable')) {
                const column = e.target.getAttribute('data-sort');
                if (column) {
                    handleSort(column);
                }
            }
        });
        
                    // Add click handlers for sorting
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM Content Loaded');
                
                // Populate period selector
                populatePeriodSelector();
                
                // Load initial data with the most recent month
                const periodSelector = document.getElementById('periodSelector');
                const initialPeriod = periodSelector.value;
                loadAccountTable(initialPeriod, 'all');

                // Add event listeners for collector cost inputs
                document.addEventListener('change', function(e) {
                    if (e.target.classList.contains('collector-cost-input')) {
                        const practice = decodeURIComponent(e.target.getAttribute('data-practice'));
                        const collectorCost = parseFloat(e.target.value) || 0;
                        updateCollectorCost(practice, collectorCost);
                    }
                });

            // Practice name click handler for modal
            document.getElementById('accountTable').addEventListener('click', async function(e) {
                console.log('Click detected on:', e.target);
                console.log('Target classList:', e.target.classList);
                console.log('Target tagName:', e.target.tagName);
                
                if (e.target && e.target.classList.contains('practice-link')) {
                    console.log('Practice link clicked!');
                    e.preventDefault();
                    const practice = decodeURIComponent(e.target.getAttribute('data-practice'));
                    console.log('Practice:', practice);
                    const periodType = document.getElementById('periodSelector').value;
                    console.log('Period type:', periodType);
                    
                    // Show loading in modal
                    document.getElementById('finClassModalLabel').textContent = 'Loading...';
                    document.getElementById('finClassPeriod').textContent = '';
                    document.getElementById('finClassPayerMix').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                    const modal = new bootstrap.Modal(document.getElementById('finClassModal'));
                    modal.show();
                    
                    try {
                        // Fetch breakdown
                        const res = await fetch(`/api/dashboard/financial-class-breakdown?practice=${encodeURIComponent(practice)}&period_type=${periodType}`);
                        console.log('Response status:', res.status);
                        if (!res.ok) {
                            throw new Error('Failed to load financial class breakdown');
                        }
                        const data = await res.json();
                        console.log('Data received:', data);
                        
                        // Set modal title to practice name
                        document.getElementById('finClassModalLabel').textContent = practice;
                        
                        if (data.breakdown && data.breakdown.length > 0) {
                            const highlightClasses = ['HCARE', 'CARE', 'HUM', 'UHC', 'AETNA'];
                            const rows = data.breakdown.map((item, i) => {
                                const highlight = highlightClasses.includes(item.class) ? " style='background:#ffeeba;font-weight:bold;'" : '';
                                return `<tr${highlight}><td>${item.class}</td><td>${item.percent}%</td></tr>`;
                            }).join('');
                            document.getElementById('finClassPayerMix').innerHTML =
                                `<table class='table table-sm table-bordered'><thead><tr><th>Financial Class</th><th>% of Total</th></tr></thead><tbody>${rows}</tbody></table>`;

                            // Calculate Total M/C (CARE + HCARE)
                            let totalMC = 0;
                            data.breakdown.forEach(item => {
                                if (item.class === 'CARE' || item.class === 'HCARE') {
                                    totalMC += parseFloat(item.percent);
                                }
                            });
                            const mcColor = totalMC >= 30 ? 'green' : 'red';
                            document.getElementById('finClassTotalMC').innerHTML = `Total M/C: <span style='color:${mcColor}'>${totalMC.toFixed(1)}%</span>`;
                        }
                    } catch (err) {
                        console.error('Error loading financial class breakdown:', err);
                        document.getElementById('finClassPayerMix').innerHTML = '<p>Error loading financial class breakdown.</p>';
                    }
                }
            });

            // Show login modal if not logged in
            if (!isLoggedIn()) {
              showLoginModal();
            }
            // Login form handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
              loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                errorDiv.style.display = 'none';
                try {
                  const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                  });
                  const data = await res.json();
                  if (res.ok && data.access_token) {
                    localStorage.setItem('access_token', data.access_token);
                    hideLoginModal();
                    location.reload();
                  } else {
                    errorDiv.textContent = data.error || 'Login failed.';
                    errorDiv.style.display = 'block';
                  }
                } catch (err) {
                  errorDiv.textContent = 'Login failed.';
                  errorDiv.style.display = 'block';
                }
              });
            }
        });

        function showLoginModal() {
          document.getElementById('loginModal').style.display = 'block';
        }
        function hideLoginModal() {
          document.getElementById('loginModal').style.display = 'none';
        }
        function isLoggedIn() {
          return !!localStorage.getItem('access_token');
        }

        // Function to populate period selector with months
        function populatePeriodSelector() {
            const periodSelector = document.getElementById('periodSelector');
            const months = [];
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Get current date
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-based
            
            // Start from the most recent full month (previous month)
            let year = currentYear;
            let month = currentMonth - 1;
            if (month < 0) {
                month = 11;
                year--;
            }
            // Only go back to March 2025 (inclusive)
            while ((year > 2025) || (year === 2025 && month >= 2)) {
                const monthName = monthNames[month];
                const value = `${monthName.toLowerCase()}_${year}`;
                const displayName = `${monthName} ${year}`;
                months.push({ value, displayName, year, month });
                // Go back one month
                month--;
                if (month < 0) {
                    month = 11;
                    year--;
                }
            }
            // Add March 2025 if not already included
            if (!months.some(m => m.value === 'march_2025')) {
                months.push({ value: 'march_2025', displayName: 'March 2025', year: 2025, month: 2 });
            }
            // Clear existing options
            periodSelector.innerHTML = '';
            // Add options
            months.forEach((monthData, index) => {
                const option = document.createElement('option');
                option.value = monthData.value;
                option.textContent = monthData.displayName;
                if (index === 0) { // First option (most recent) is selected by default
                    option.selected = true;
                }
                periodSelector.appendChild(option);
            });
        }

        // Function to update collector cost
        async function updateCollectorCost(practice, collectorCost) {
            const input = document.querySelector(`[data-practice="${encodeURIComponent(practice)}"].collector-cost-input`);
            const spinner = input.parentElement.querySelector('.collector-spinner');
            
            try {
                spinner.style.display = 'inline-block';
                input.disabled = true;
                
                const response = await fetch('/api/dashboard/update-collector-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        practice: practice,
                        collector_cost: collectorCost
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update collector cost');
                }
                
                // Reload data to reflect changes
                reloadData();
                
            } catch (error) {
                console.error('Error updating collector cost:', error);
                alert('Failed to update collector cost. Please try again.');
                // Reset input to previous value
                reloadData();
            } finally {
                spinner.style.display = 'none';
                input.disabled = false;
            }
        }
    </script>
</body>
</html>